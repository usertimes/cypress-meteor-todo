{"version":3,"sources":["meteor://ðŸ’»app/packages/react-meteor-data/index.js","meteor://ðŸ’»app/packages/react-meteor-data/useTracker.ts","meteor://ðŸ’»app/packages/react-meteor-data/withTracker.tsx"],"names":["React","module","link","default","v","Meteor","isDevelopment","version","split","console","warn"],"mappings":"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","file":"/packages/react-meteor-data.js","sourcesContent":["/* global Meteor*/\nimport React from 'react';\n\nif (Meteor.isDevelopment) {\n  const v = React.version.split('.');\n  if (v[0] < 16 || (v[0] == 16 && v[1] < 8)) {\n    console.warn('react-meteor-data 2.x requires React version >= 16.8.');\n  }\n}\n\nexport { default as useTracker } from './useTracker';\nexport { default as withTracker } from './withTracker.tsx';\n","declare var Package: any\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { useReducer, useEffect, useRef, useMemo, DependencyList } from 'react';\n\n// Warns if data is a Mongo.Cursor or a POJO containing a Mongo.Cursor.\nfunction checkCursor (data: any): void {\n  let shouldWarn = false;\n  if (Package.mongo && Package.mongo.Mongo && data && typeof data === 'object') {\n    if (data instanceof Package.mongo.Mongo.Cursor) {\n      shouldWarn = true;\n    } else if (Object.getPrototypeOf(data) === Object.prototype) {\n      Object.keys(data).forEach((key) => {\n        if (data[key] instanceof Package.mongo.Mongo.Cursor) {\n          shouldWarn = true;\n        }\n      });\n    }\n  }\n  if (shouldWarn) {\n    console.warn(\n      'Warning: your reactive function is returning a Mongo cursor. '\n      + 'This value will not be reactive. You probably want to call '\n      + '`.fetch()` on the cursor before returning it.'\n    );\n  }\n}\n\n// Used to create a forceUpdate from useReducer. Forces update by\n// incrementing a number whenever the dispatch method is invoked.\nconst fur = (x: number): number => x + 1;\nconst useForceUpdate = () => useReducer(fur, 0)[1];\n\nexport interface IReactiveFn<T> {\n  <T>(c?: Tracker.Computation): T\n}\n\nexport interface ISkipUpdate<T> {\n  <T>(prev: T, next: T): boolean\n}\n\ntype TrackerRefs = {\n  computation?: Tracker.Computation;\n  isMounted: boolean;\n  trackerData: any;\n}\n\nconst useTrackerNoDeps = <T = any>(reactiveFn: IReactiveFn<T>, skipUpdate: ISkipUpdate<T> = null) => {\n  const { current: refs } = useRef<TrackerRefs>({\n    isMounted: false,\n    trackerData: null\n  });\n  const forceUpdate = useForceUpdate();\n\n  // Without deps, always dispose and recreate the computation with every render.\n  if (refs.computation) {\n    refs.computation.stop();\n    // @ts-ignore This makes TS think ref.computation is \"never\" set\n    delete refs.computation;\n  }\n\n  // Use Tracker.nonreactive in case we are inside a Tracker Computation.\n  // This can happen if someone calls `ReactDOM.render` inside a Computation.\n  // In that case, we want to opt out of the normal behavior of nested\n  // Computations, where if the outer one is invalidated or stopped,\n  // it stops the inner one.\n  Tracker.nonreactive(() => Tracker.autorun((c: Tracker.Computation) => {\n    refs.computation = c;\n    if (c.firstRun) {\n      // Always run the reactiveFn on firstRun\n      refs.trackerData = reactiveFn(c);\n    } else if (!skipUpdate || !skipUpdate(refs.trackerData, reactiveFn(c))) {\n      // For any reactive change, forceUpdate and let the next render rebuild the computation.\n      forceUpdate();\n    }\n  }));\n\n  // To avoid creating side effects in render with Tracker when not using deps\n  // create the computation, run the user's reactive function in a computation synchronously,\n  // then immediately dispose of it. It'll be recreated again after the render is committed.\n  if (!refs.isMounted) {\n    // We want to forceUpdate in useEffect to support StrictMode.\n    // See: https://github.com/meteor/react-packages/issues/278\n    if (refs.computation) {\n      refs.computation.stop();\n      delete refs.computation;\n    }\n  }\n\n  useEffect(() => {\n    // Let subsequent renders know we are mounted (render is committed).\n    refs.isMounted = true;\n\n    // Render is committed. Since useTracker without deps always runs synchronously,\n    // forceUpdate and let the next render recreate the computation.\n    if (!skipUpdate) {\n      forceUpdate();\n    } else {\n      Tracker.nonreactive(() => Tracker.autorun((c: Tracker.Computation) => {\n        refs.computation = c;\n        if (!skipUpdate(refs.trackerData, reactiveFn(c))) {\n          // For any reactive change, forceUpdate and let the next render rebuild the computation.\n          forceUpdate();\n        }\n      }));\n    }\n\n    // stop the computation on unmount\n    return () =>{\n      refs.computation?.stop();\n    }\n  }, []);\n\n  return refs.trackerData;\n}\n\nconst useTrackerWithDeps = <T = any>(reactiveFn: IReactiveFn<T>, deps: DependencyList, skipUpdate: ISkipUpdate<T> = null): T => {\n  const forceUpdate = useForceUpdate();\n\n  const { current: refs } = useRef<{\n    reactiveFn: IReactiveFn<T>;\n    data?: T;\n  }>({ reactiveFn });\n\n  // keep reactiveFn ref fresh\n  refs.reactiveFn = reactiveFn;\n\n  useMemo(() => {\n    // To jive with the lifecycle interplay between Tracker/Subscribe, run the\n    // reactive function in a computation, then stop it, to force flush cycle.\n    const comp = Tracker.nonreactive(\n      () => Tracker.autorun((c: Tracker.Computation) => {\n        refs.data = refs.reactiveFn();\n      })\n    );\n    // To avoid creating side effects in render, stop the computation immediately\n    Meteor.defer(() => { comp.stop() });\n  }, deps);\n\n  useEffect(() => {\n    const computation = Tracker.nonreactive(\n      () => Tracker.autorun((c) => {\n        const data: T = refs.reactiveFn(c);\n        if (!skipUpdate || !skipUpdate(refs.data, data)) {\n          refs.data = data;\n          forceUpdate();\n        }\n      })\n    );\n    return () => {\n      computation.stop();\n    };\n  }, deps);\n\n  return refs.data as T;\n};\n\nfunction useTrackerClient <T = any>(reactiveFn: IReactiveFn<T>, skipUpdate?: ISkipUpdate<T>): T;\nfunction useTrackerClient <T = any>(reactiveFn: IReactiveFn<T>, deps?: DependencyList, skipUpdate?: ISkipUpdate<T>): T;\nfunction useTrackerClient <T = any>(reactiveFn: IReactiveFn<T>, deps: DependencyList | ISkipUpdate<T> = null, skipUpdate: ISkipUpdate<T> = null): T {\n  if (deps === null || deps === undefined || !Array.isArray(deps)) {\n    if (typeof deps === \"function\") {\n      skipUpdate = deps;\n    }\n    return useTrackerNoDeps(reactiveFn, skipUpdate);\n  } else {\n    return useTrackerWithDeps(reactiveFn, deps, skipUpdate);\n  }\n}\n\nconst useTrackerServer: typeof useTrackerClient = (reactiveFn) => {\n  return Tracker.nonreactive(reactiveFn);\n}\n\n// When rendering on the server, we don't want to use the Tracker.\n// We only do the first rendering on the server so we can get the data right away\nconst useTracker = Meteor.isServer\n  ? useTrackerServer\n  : useTrackerClient;\n\nfunction useTrackerDev (reactiveFn, deps = null, skipUpdate = null) {\n  function warn (expects: string, pos: string, arg: string, type: string) {\n    console.warn(\n      `Warning: useTracker expected a ${expects} in it\\'s ${pos} argument `\n        + `(${arg}), but got type of \\`${type}\\`.`\n    );\n  }\n\n  if (typeof reactiveFn !== 'function') {\n    warn(\"function\", \"1st\", \"reactiveFn\", reactiveFn);\n  }\n\n  if (deps && skipUpdate && !Array.isArray(deps) && typeof skipUpdate === \"function\") {\n    warn(\"array & function\", \"2nd and 3rd\", \"deps, skipUpdate\",\n      `${typeof deps} & ${typeof skipUpdate}`);\n  } else {\n    if (deps && !Array.isArray(deps) && typeof deps !== \"function\") {\n      warn(\"array or function\", \"2nd\", \"deps or skipUpdate\", typeof deps);\n    }\n    if (skipUpdate && typeof skipUpdate !== \"function\") {\n      warn(\"function\", \"3rd\", \"skipUpdate\", typeof skipUpdate);\n    }\n  }\n\n  const data = useTracker(reactiveFn, deps, skipUpdate);\n  checkCursor(data);\n  return data;\n}\n\nexport default Meteor.isDevelopment\n  ? useTrackerDev as typeof useTrackerClient\n  : useTracker;\n","import React, { forwardRef, memo } from 'react';\nimport useTracker from './useTracker';\n\ntype ReactiveFn = (props: object) => any;\ntype ReactiveOptions = {\n  getMeteorData: ReactiveFn;\n  pure?: boolean;\n  skipUpdate?: (prev: any, next: any) => boolean;\n}\n\nexport default function withTracker(options: ReactiveFn | ReactiveOptions) {\n  return (Component: React.ComponentType) => {\n    const getMeteorData = typeof options === 'function'\n      ? options\n      : options.getMeteorData;\n\n    const WithTracker = forwardRef((props, ref) => {\n      const data = useTracker(\n        () => getMeteorData(props) || {},\n        (options as ReactiveOptions).skipUpdate\n      );\n      return (\n        <Component ref={ref} {...props} {...data} />\n      );\n    });\n\n    const { pure = true } = options as ReactiveOptions;\n    return pure ? memo(WithTracker) : WithTracker;\n  };\n}\n"]}